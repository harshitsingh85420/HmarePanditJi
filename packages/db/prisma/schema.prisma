generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  CUSTOMER
  PANDIT
  ADMIN
}

enum VerificationStatus {
  PENDING
  DOCUMENTS_SUBMITTED
  VIDEO_KYC_DONE
  VERIFIED
  REJECTED
}

enum BookingStatus {
  CREATED
  PANDIT_REQUESTED
  CONFIRMED
  TRAVEL_BOOKED
  PANDIT_EN_ROUTE
  PANDIT_ARRIVED
  PUJA_IN_PROGRESS
  COMPLETED
  CANCELLATION_REQUESTED
  CANCELLED
  REFUNDED
}

enum TravelMode {
  SELF_DRIVE
  TRAIN
  FLIGHT
  CAB
  BUS
}

enum TravelStatus {
  NOT_REQUIRED
  PENDING
  ADMIN_CALCULATING
  BOOKED
  IN_TRANSIT
  ARRIVED
}

enum SamagriPreference {
  PANDIT_BRINGS
  CUSTOMER_ARRANGES
  NEED_HELP
}

enum FoodArrangement {
  CUSTOMER_PROVIDES
  PLATFORM_ALLOWANCE
}

enum AccommodationArrangement {
  NOT_NEEDED
  CUSTOMER_ARRANGES
  PLATFORM_BOOKS
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum RefundStatus {
  NONE
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PackageType {
  BASIC
  STANDARD
  PREMIUM
}

// ============ MODELS ============

model User {
  id          String   @id @default(cuid())
  phone       String   @unique  // "+919876543210" format always
  name        String?
  email       String?
  role        Role     @default(CUSTOMER)
  isVerified  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customerProfile    CustomerProfile?
  panditProfile      PanditProfile?
  bookingsAsCustomer Booking[]             @relation("CustomerBookings")
  bookingsAsPandit   Booking[]             @relation("PanditBookings")
  reviewsGiven       Review[]              @relation("ReviewsGiven")
  reviewsReceived    Review[]              @relation("ReviewsReceived")
  favoritePandits    FavoritePandit[]      @relation("CustomerFavorites")
  favoritedBy        FavoritePandit[]      @relation("PanditFavorited")
  statusUpdates      BookingStatusUpdate[]
  notifications      Notification[]
  familyMembers      FamilyMember[]

  @@index([role])
  @@index([isActive])
}

model CustomerProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id])
  preferredLanguages String[]
  gotra              String?  // Family gotra for ritual matching
  addresses          Address[]
  createdAt          DateTime @default(now())
}

model Address {
  id                String          @id @default(cuid())
  customerProfileId String
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id])
  label             String          // "Home", "Office", "Parents' House"
  fullAddress       String
  city              String
  state             String
  pincode           String
  landmark          String?
  latitude          Float?
  longitude         Float?
  isDefault         Boolean         @default(false)
}

model PanditProfile {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id])
  bio                  String?
  experienceYears      Int                @default(0)
  languages            String[]
  specializations      String[]           // ["Vivah", "Griha Pravesh", ...]
  verificationStatus   VerificationStatus @default(PENDING)
  aadhaarVerified      Boolean            @default(false)
  videoKycCompleted    Boolean            @default(false)
  certificateUrls      String[]
  aadhaarFrontUrl      String?
  aadhaarBackUrl       String?
  videoKycUrl          String?
  profilePhotoUrl      String?

  location    String  // City name e.g. "Varanasi"
  fullAddress String?

  // Ratings & Stats
  rating            Float @default(0)
  totalReviews      Int   @default(0)
  completedBookings Int   @default(0)

  // Travel — stored as JSON for flexibility
  // Schema: { maxDistanceKm: 500, preferredModes: ["SELF_DRIVE","TRAIN"], selfDriveRatePerKm: 12, vehicleType: "Car", hotelPreference: "3_STAR", advanceNoticeDays: 2 }
  travelPreferences Json @default("{}")

  // Bank details for payouts
  bankAccountName   String?
  bankAccountNumber String?
  bankIfscCode      String?
  bankName          String?  // Auto-fetched from IFSC
  bankVerified      Boolean  @default(false)
  upiId             String?

  // Device info — auto-captured during registration, shown to customers so they know pandit is tech-equipped
  deviceOs    String?  // "Android 12", "iOS 16"
  deviceModel String?  // "Samsung Galaxy A32"
  appVersion  String?

  isOnline Boolean @default(false) // Pandit's online/offline toggle
  canBringSamagri Boolean @default(true) // Added for Samagri Toggle

  // Admin Verification Tracking
  adminNotes           String?  @db.Text
  rejectionReason      String?  @db.Text
  verifiedAt           DateTime?
  verifiedById         String?
  profileCompletionPercent Int  @default(0)

  pujaServices    PujaService[]
  blockedDates    PanditBlockedDate[]
  samagriPackages SamagriPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([verificationStatus])
  @@index([location])
  @@index([isOnline])
  @@index([rating])
}

model PujaService {
  id              String        @id @default(cuid())
  panditProfileId String
  panditProfile   PanditProfile @relation(fields: [panditProfileId], references: [id])
  pujaType        String        // "Vivah", "Griha Pravesh" etc.
  dakshinaAmount  Int           // In rupees, no decimals
  durationHours   Float         // e.g. 3.5 hours
  description     String?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())

  @@index([panditProfileId])
  @@index([pujaType])
}

model SamagriPackage {
  id              String        @id @default(cuid())
  panditProfileId String
  panditProfile   PanditProfile @relation(fields: [panditProfileId], references: [id])
  packageName     String        // "Basic", "Standard", "Premium"
  packageType     PackageType
  pujaType        String        // Which puja this package is for
  fixedPrice      Int           // FIXED, non-negotiable, set by pandit
  // items: JSON array of { itemName: string, quantity: string, qualityNotes?: string }
  // Example: [{"itemName":"Desi Ghee","quantity":"500g","qualityNotes":"Shuddh cow ghee"}]
  items    Json
  isActive Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([panditProfileId])
}

model PanditBlockedDate {
  id              String        @id @default(cuid())
  panditProfileId String
  panditProfile   PanditProfile @relation(fields: [panditProfileId], references: [id])
  date            DateTime
  reason          String?
  isRecurring     Boolean       @default(false)
  recurringRule   String?       // "EVERY_TUESDAY", "EVERY_MONTH_15"
  createdAt       DateTime      @default(now())

  @@index([panditProfileId])
  @@index([date])
}

model Booking {
  id            String        @id @default(cuid())
  bookingNumber String        @unique // "HPJ-2026-ABC12"

  customerId String
  customer   User   @relation("CustomerBookings", fields: [customerId], references: [id])
  panditId   String? // Null until pandit is assigned
  pandit     User?   @relation("PanditBookings", fields: [panditId], references: [id])

  status BookingStatus @default(CREATED)

  // Event details
  eventType        String   // "Vivah", "Griha Pravesh" etc.
  eventDate        DateTime
  eventEndDate     DateTime? // For multi-day events like Vivah
  completedAt      DateTime? // When booking was marked COMPLETED
  muhuratTime      String?   // "10:30 AM - 12:00 PM"
  muhuratSuggested Boolean   @default(false)

  // Venue
  venueAddress        String
  venueCity           String
  venuePincode        String
  venueLatitude       Float?
  venueLongitude      Float?
  attendees           Int?
  specialInstructions String?

  // Travel
  travelRequired   Boolean      @default(false)
  travelMode       TravelMode?
  travelDistanceKm Float?
  travelStatus         TravelStatus @default(NOT_REQUIRED)
  travelBookingRef     String?      // Admin manually enters IRCTC/MMT reference
  travelNotes          String?
  calculatedTravelCost Int?
  travelBreakdown      Json?
  travelBookingDetails Json?
  travelDocumentUrls   String[]

  // Food & Accommodation
  foodArrangement          FoodArrangement          @default(CUSTOMER_PROVIDES)
  foodAllowanceDays        Int                      @default(0)
  foodAllowanceAmount      Int                      @default(0) // foodAllowanceDays * 1000
  accommodationArrangement AccommodationArrangement @default(NOT_NEEDED)
  accommodationCost        Int                      @default(0)

  // Samagri
  samagriPreference SamagriPreference @default(PANDIT_BRINGS)
  samagriPackageId  String?           // If PANDIT_BRINGS and chose a fixed package
  samagriCustomList Json?             // If PANDIT_BRINGS with custom list or NEED_HELP
  samagriAmount     Int               @default(0)
  samagriNotes      String?

  // Pricing — ALL amounts stored in rupees (integers, no decimals)
  dakshinaAmount      Int @default(0)
  travelCost          Int @default(0)
  platformFee         Int @default(0)  // 15% of dakshina
  platformFeeGst      Int @default(0)  // 18% of platformFee
  travelServiceFee    Int @default(0)  // 5% of travelCost
  travelServiceFeeGst Int @default(0)  // 18% of travelServiceFee
  grandTotal          Int @default(0)

  // Pandit payout
  panditPayout      Int          @default(0) // dakshina - platformFee + travel + food + samagri
  payoutStatus      PayoutStatus @default(PENDING)
  payoutReference   String?
  payoutCompletedAt DateTime?

  // Cancellation
  cancelledBy             String?      // "CUSTOMER" | "PANDIT" | "ADMIN"
  cancellationReason      String?
  cancellationRequestedAt DateTime?
  cancelledAt             DateTime?
  refundAmount            Int          @default(0)
  refundStatus            RefundStatus @default(NONE)
  refundReference         String?

  // Payment
  razorpayOrderId   String?
  razorpayPaymentId String?
  paymentStatus     PaymentStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statusUpdates BookingStatusUpdate[]
  review        Review?

  @@index([customerId])
  @@index([panditId])
  @@index([status])
  @@index([eventDate])
  @@index([bookingNumber])
  @@index([paymentStatus])
}

model BookingStatusUpdate {
  id          String        @id @default(cuid())
  bookingId   String
  booking     Booking       @relation(fields: [bookingId], references: [id])
  fromStatus  BookingStatus
  toStatus    BookingStatus
  updatedById String
  updatedBy   User          @relation(fields: [updatedById], references: [id])
  note        String?
  latitude    Float?        // Pandit's GPS when tapping "I'm Here" buttons
  longitude   Float?
  createdAt   DateTime      @default(now())

  @@index([bookingId])
}

model Review {
  id                   String   @id @default(cuid())
  bookingId            String   @unique
  booking              Booking  @relation(fields: [bookingId], references: [id])
  reviewerId           String
  reviewer             User     @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  revieweeId           String
  reviewee             User     @relation("ReviewsReceived", fields: [revieweeId], references: [id])
  overallRating        Float    // 1.0 to 5.0
  knowledgeRating      Float?
  punctualityRating    Float?
  communicationRating  Float?
  valueForMoneyRating  Float?
  comment              String?
  photoUrls            String[]
  isAnonymous          Boolean  @default(false)
  createdAt            DateTime @default(now())

  @@index([revieweeId])
}

model FavoritePandit {
  id         String   @id @default(cuid())
  customerId String
  customer   User     @relation("CustomerFavorites", fields: [customerId], references: [id])
  panditId   String
  pandit     User     @relation("PanditFavorited", fields: [panditId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([customerId, panditId])
  @@index([customerId])
}

model MuhuratDate {
  id           String   @id @default(cuid())
  date         DateTime
  pujaType     String   // "Vivah", "Griha Pravesh" etc.
  timeWindow   String   // "10:30 AM - 12:00 PM"
  significance String?  // "Akshaya Tritiya — highly auspicious for new beginnings"
  source       String   // "Hindu Panchang 2026"

  @@index([date])
  @@index([pujaType])
  @@unique([date, pujaType, timeWindow])
}

model CityDistance {
  id                  String @id @default(cuid())
  fromCity            String
  toCity              String
  distanceKm          Float
  estimatedDriveHours Float?

  @@unique([fromCity, toCity])
  @@index([fromCity])
}

model SupportTicket {
  id               String   @id @default(cuid())
  source           String
  type             String
  subject          String
  description      String   @db.Text
  priority         String   @default("MEDIUM")
  status           String   @default("OPEN")
  relatedBookingId String?
  relatedUserId    String?
  resolution       String?  @db.Text
  createdBy        String   // admin who logged it
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([status])
  @@index([priority])
}

model FamilyMember {
  id        String    @id @default(cuid())
  userId    String
  name      String
  relation  String
  dob       DateTime?
  nakshatra String?
  rashi     String?
  user      User      @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // BOOKING, TRAVEL, STATUS, PAYMENT, REVIEW, SYSTEM
  title     String
  message   String
  data      Json?    // { bookingId?, panditId?, etc. }
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model CustomerRating {
  id              String   @id @default(cuid())
  bookingId       String   @unique
  panditId        String
  customerId      String
  punctuality     Int      // 1-5
  hospitality     Int      // 1-5
  foodArrangement Int      // 1-5
  comment         String?
  createdAt       DateTime @default(now())
}
